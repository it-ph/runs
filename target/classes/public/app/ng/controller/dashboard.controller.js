angular.module("run_proud").controller("DashboardController",["$rootScope","$scope","$state","$cookies","Access","RunEventDataOp",function(e,s,t,n,r,i){s.user={},s.activeRun=null,s.newRecord={},s.error=null,s.runEventReg=null,s.battles={selected:null,list:[]},s.enable_add=!1,s.selectedRun={},s.userProgress={},s.selectedBattle="",s.entitlements=[{name:"- SELECT YOUR ENTITLEMENT -",cost:0}],s.selectedEntitlement=s.entitlements[0],s.ent={selected:null,list:[{name:"- SELECT YOUR ENTITLEMENT -",cost:0}],hasSelected:function(){return 0<this.selected.cost},isDisabled:function(){return 1==this.list.length}},s.run_reg={},s.ent.selected=s.ent.list[0],s.shirtSize={list:[{name:"XS",desc:"EXTRA SMALL"},{name:"S",desc:"SMALL"},{name:"M",desc:"MEDIUM"},{name:"L",desc:"LARGE"},{name:"XL",desc:"EXTRA LARGE"},{name:"XXL",desc:"EXTRA EXTRA LARGE"}],selected:null},s.shirtSize.selected=s.shirtSize.list[0],s.isAdmin=function(){return"ADMIN"==s.user.role},s.currentRun=null,s.auth_pay=!1,s.regDetail={auth:!1,event_id:null,entitlement:null,shirt:null},s.time_change=function(){console.log("time chanaged ")},s.submitions={data:[],currentPageList:[],filteredList:[],totalItems:0,numPages:void 0,maxSize:5,currentPage:1,boundary_links:!0,numPerPage:10,numPerPageSelections:[5,10,20,50,100],pageChange:function(){var e=(this.currentPage-1)*this.numPerPage,t=e+this.numPerPage;this.currentPageList=this.filteredList.slice(e,t)},searchKeyword:"",searchDB:function(){this.filteredList=$filter("filter")(this.data,this.searchKeyword),this.totalItems=this.filteredList.length;var e=(this.currentPage-1)*this.numPerPage,t=e+this.numPerPage;this.currentPageList=this.filteredList.slice(e,t)},numPageChange:function(){var e=(this.currentPage-1)*this.numPerPage,t=e+this.numPerPage;this.currentPageList=this.filteredList.slice(e,t)},init:function(e){this.data=e,this.totalItems=e.length,this.filteredList=e;var t=(this.currentPage-1)*this.numPerPage,n=t+this.numPerPage;this.currentPageList=this.filteredList.slice(t,n)}},s.canAddRecord=function(){return s.enable_add},s.getActiveRunReg=function(){i.getActiveRunReg().then(function(e){if(0<Object.getOwnPropertyNames(e.data).length){s.runEventReg=e.data;var t=moment(new Date),n=moment(e.data.runEvent.runStart),r=moment.duration(n.diff(t));s.enable_add=r._milliseconds<=0&&e.data.approved}}).catch(function(e){console.log(e),console.log(e)})},s.getUserProgress=function(e){i.getUserProgress(s.currentRun).then(function(e){0<Object.getOwnPropertyNames(e.data).length&&(s.userProgress=e.data,distance=e.data.distanceTraveled,totalDistance=s.runEventReg.eventCateg.distance,percent=distance/totalDistance*100,s.userProgress.percent=percent)}).catch(function(e){console.log(e)})},s.getCurrentRun=function(){i.getCurrentRun().then(function(e){0<Object.getOwnPropertyNames(e.data).length&&(s.currentRun=e.data,s.getUserProgress(e.data))}).catch(function(e){console.log(e)})},s.getEntitlements=function(){i.getEntitlements().then(function(e){data=e.data,s.ent.list=e.data,s.ent.selected=s.ent.list[0]}).catch(function(e){console.log(e)})},s.getRunCategories=function(){i.getRunCategories().then(function(e){s.battles.list=e.data,s.battles.selected=s.battles.list[0]}).catch(function(e){console.log(e)})},s.getRunRecords=function(){i.getRunRecords().then(function(e){s.submitions.init(e.data)}).catch(function(e){console.log(e)})},s.registerRun=function(){reg={user:s.user,runEvent:s.currentRun,eventCateg:s.battles.selected,entitlement:s.ent.selected,shirtSize:s.shirtSize.selected.name},console.log(reg),i.registerRun(reg).then(function(e){console.log(e),s.getActiveRunReg()}).catch(function(e){console.log(e)})},s.addNewRecord=function(){s.error=null;var e={};e.user=s.runEventReg.user,e.event=s.runEventReg.runEvent,e.eventCategory=s.runEventReg.eventCateg,e.distanceTraveled=s.newRecord.distance,e.totalElapseTime=moment(s.newRecord.time).format("HH:mm:ss"),console.log(s.newRecord.time);var t=new FormData;"00:00:00"!=e.totalElapseTime&&null!=s.newRecord.time||(s.error="Invalid time"),s.error||(t.append("file",s.newRecord.file),t.append("record",angular.toJson(e)),console.log(s.error),i.submitRecord(t).then(function(e){console.log(e),s.getUserProgress(s.currentRun),s.getRunRecords(),$("#add-record").modal("hide")}).catch(function(e){console.log(e)}))},s.records={numPerPage:5,numPerPageSelections:[5,10,20,50,100],numPageChange:function(){console.log("num page change")}},s.showUploadModal=function(){s.newRecord={},s.newRecord.time=null,s.error=null,$("#add-record").modal("show")},s.checkUser=function(){if(r.user)s.initData(),s.user=r.getUser(),s.$emit("childEmit",s.user);else{var e=n.get("run_proud_token");e?r.getClaimsFromToken(e,function(e){s.user=e.data.principal.user,s.$emit("childEmit",s.user),s.initData()},function(e){console.log(e),r.clearData(),n.remove("run_proud_token"),t.go("login")}):t.go("login")}},s.canRegister=function(){return s.currentRun&&!s.runEventReg},s.registerDisabled=function(){return!(s.ent.selected&&s.shirtSize.selected&&s.regDetail.auth)},s.showAttachment=function(e){s.selectedRun=e,console.log(s.selectedRun),$("#img-attach").modal("show")},s.initData=function(){s.getActiveRunReg(),s.getCurrentRun(),s.getEntitlements(),s.getRunCategories(),s.getRunRecords()},s.checkUser()}]);